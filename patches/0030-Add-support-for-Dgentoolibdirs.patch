From da4cef0a31504f97390c3df9e1016690d7f5aa80 Mon Sep 17 00:00:00 2001
From: Kent Fredric <kentnl@gentoo.org>
Date: Sun, 16 May 2021 15:00:02 +0200
Subject: [PATCH 30/30] Add support for -Dgentoolibdirs
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Which just adds the libdirs verbatim in the right place without
having perl molest it in the process.

Ported to 5.34 by Andreas K. Hüttel <dilfridge@gentoo.org>

Signed-off-by: Andreas K. Hüttel <dilfridge@gentoo.org>
---
 Configure                      | 26 ++++++++++++++++++++++++++
 Cross/config.sh-arm-linux      |  2 ++
 Cross/config.sh-arm-linux-n770 |  2 ++
 NetWare/config.wc              |  2 ++
 Porting/config.sh              |  2 ++
 config_h.SH                    |  5 +++++
 configure.com                  |  2 ++
 perl.c                         |  1 +
 perl_inc_macro.h               |  8 ++++++++
 plan9/config_sh.sample         |  2 ++
 uconfig.h                      | 11 ++++++++---
 uconfig.sh                     |  2 ++
 uconfig64.sh                   |  2 ++
 win32/config.gc                |  2 ++
 win32/config.vc                |  2 ++
 15 files changed, 68 insertions(+), 3 deletions(-)

diff --git a/Configure b/Configure
index 5b04023159..7be614d43e 100755
--- a/Configure
+++ b/Configure
@@ -1161,6 +1161,8 @@ orderlib=''
 ranlib=''
 d_perl_otherlibdirs=''
 otherlibdirs=''
+gentoolibdirs=''
+d_gentoolibdirs=''
 package=''
 spackage=''
 pager=''
@@ -7991,6 +7993,28 @@ esac
 set d_perl_otherlibdirs
 eval $setvar
 
+case "$gentoolibdirs" in
+''|' ') dflt='none' ;;
+*) dflt="$gentoolibdirs" ;;
+esac
+$cat <<EOM
+Enter a colon-seperated list of explicit gentoo paths to stuff in @INC
+unmolested, or enter 'none' for no extra paths
+
+EOM
+rp='Colon-seperated list of gentoo-specific perl library search dirs?'
+. ./myread
+case "$ans" in
+' '|''|none) gentoolibdirs=' ';;
+*) gentoolibdirs="$ans" ;;
+esac
+case "$gentoolibdirs" in
+' ') val=$undef ;;
+*) val=$define ;;
+esac
+set d_gentoolibdirs
+eval $setvar
+
 : DTrace support
 dflt_dtrace='/usr/sbin/dtrace'
 $test -x /usr/bin/dtrace && dflt_dtrace='/usr/bin/dtrace'
@@ -24415,6 +24439,7 @@ d_openat='$d_openat'
 d_pathconf='$d_pathconf'
 d_pause='$d_pause'
 d_perl_otherlibdirs='$d_perl_otherlibdirs'
+d_gentoolibdirs='$d_gentoolibdirs'
 d_phostname='$d_phostname'
 d_pipe2='$d_pipe2'
 d_pipe='$d_pipe'
@@ -24950,6 +24975,7 @@ orderlib='$orderlib'
 osname='$osname'
 osvers='$osvers'
 otherlibdirs='$otherlibdirs'
+gentoolibdirs='$gentoolibdirs'
 package='$package'
 pager='$pager'
 passcat='$passcat'
diff --git a/Cross/config.sh-arm-linux b/Cross/config.sh-arm-linux
index 33bab37392..c678288f36 100644
--- a/Cross/config.sh-arm-linux
+++ b/Cross/config.sh-arm-linux
@@ -246,6 +246,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -689,6 +690,7 @@ full_sed='/bin/sed'
 gccansipedantic=''
 gccosandvers=''
 gccversion='2.95.3 20010125 (prerelease)'
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/Cross/config.sh-arm-linux-n770 b/Cross/config.sh-arm-linux-n770
index 73567fbae9..85da005ceb 100644
--- a/Cross/config.sh-arm-linux-n770
+++ b/Cross/config.sh-arm-linux-n770
@@ -245,6 +245,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -687,6 +688,7 @@ full_sed='/bin/sed'
 gccansipedantic=''
 gccosandvers=''
 gccversion='2.95.3 20010125 (prerelease)'
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/NetWare/config.wc b/NetWare/config.wc
index 26c1755798..bfd4e8b599 100644
--- a/NetWare/config.wc
+++ b/NetWare/config.wc
@@ -234,6 +234,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -676,6 +677,7 @@ full_ar=''
 full_csh=''
 full_sed=''
 gccversion=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/Porting/config.sh b/Porting/config.sh
index d1f54f2f63..d10d31a38e 100644
--- a/Porting/config.sh
+++ b/Porting/config.sh
@@ -262,6 +262,7 @@ d_futimes='define'
 d_gai_strerror='define'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='define'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -713,6 +714,7 @@ full_sed='/usr/bin/sed'
 gccansipedantic=''
 gccosandvers=''
 gccversion='10.2.1 20200805 [revision dda1e9d08434def88ed86557d08b23251332c5aa]'
+gentoolibdirs=''
 getgrent_r_proto='REENTRANT_PROTO_I_SBWR'
 getgrgid_r_proto='REENTRANT_PROTO_I_TSBWR'
 getgrnam_r_proto='REENTRANT_PROTO_I_CSBWR'
diff --git a/config_h.SH b/config_h.SH
index 8264f91dce..f4c4e58d3a 100755
--- a/config_h.SH
+++ b/config_h.SH
@@ -1308,6 +1308,11 @@ sed <<!GROK!THIS! >$CONFIG_H -e 's!^#undef\(.*/\)\*!/\*#define\1 \*!' -e 's!^#un
  */
 #$d_perl_otherlibdirs PERL_OTHERLIBDIRS "$otherlibdirs"		/**/
 
+/* GENTOO_LIBDIRS:
+ * Like PERL_OTHERLIBDIRS, but doesn't stuff ARCH dirs in when not wanted
+ */
+#$d_gentoolibdirs GENTOO_LIBDIRS "$gentoolibdirs"		/**/
+
 /* PRIVLIB:
  *	This symbol contains the name of the private library for this package.
  *	The library is private in the sense that it needn't be in anyone's
diff --git a/configure.com b/configure.com
index df2958201e..51d1ad077b 100644
--- a/configure.com
+++ b/configure.com
@@ -6675,6 +6675,7 @@ $ WC "full_ar='" + "'"
 $ WC "full_csh='" + " '"
 $ WC "full_sed='_NLA0:'"
 $ WC "gccversion='" + gccversion + "'"
+$ WC "gentoolibdirs='" + "'"
 $ WC "gidformat='lu'"
 $ WC "gidsign='1'"
 $ WC "gidsize='4'"
@@ -7072,6 +7073,7 @@ $ WC "d_endpwent_r='undef'"
 $ WC "d_endservent_r='undef'"
 $ WC "d_freelocale='undef'"
 $ WC "d_gai_strerror='define'"
+$ WC "d_gentoolibdirs='undef'"
 $ WC "d_getgrent_r='undef'"
 $ WC "d_getgrgid_r='" + d_getgrgid_r + "'"
 $ WC "d_getgrnam_r='" + d_getgrnam_r + "'"
diff --git a/perl.c b/perl.c
index 88c3afcedb..2fad87151d 100644
--- a/perl.c
+++ b/perl.c
@@ -4734,6 +4734,7 @@ S_init_perllib(pTHX)
     INCPUSH_ARCHLIB_EXP
     INCPUSH_PRIVLIB_EXP
     INCPUSH_PERL_OTHERLIBDIRS
+    INCPUSH_GENTOO_LIBDIRS
     INCPUSH_PERL5LIB
     INCPUSH_APPLLIB_OLD_EXP
     INCPUSH_PERL_OTHERLIBDIRS_ARCHONLY
diff --git a/perl_inc_macro.h b/perl_inc_macro.h
index b9cd60947e..5f310f22d8 100644
--- a/perl_inc_macro.h
+++ b/perl_inc_macro.h
@@ -143,6 +143,14 @@
                       INCPUSH_ADD_OLD_VERS|INCPUSH_CAN_RELOCATE);
 #endif
 
+#ifdef GENTOO_LIBDIRS
+# define INCPUSH_GENTOO_LIBDIRS S_incpush_use_sep(aTHX_ STR_WITH_LEN(GENTOO_LIBDIRS), \
+    INCPUSH_ADD_OLD_VERS|INCPUSH_CAN_RELOCATE);
+#endif
+#ifndef INCPUSH_GENTOO_LIBDIRS
+# define INCPUSH_GENTOO_LIBDIRS
+#endif
+
 #ifdef PERL_OTHERLIBDIRS
 #	define INCPUSH_PERL_OTHERLIBDIRS_ARCHONLY  S_incpush_use_sep(aTHX_ STR_WITH_LEN(PERL_OTHERLIBDIRS), \
                       INCPUSH_ADD_OLD_VERS|INCPUSH_ADD_ARCHONLY_SUB_DIRS|INCPUSH_CAN_RELOCATE);
diff --git a/plan9/config_sh.sample b/plan9/config_sh.sample
index b76136370c..f564adac53 100644
--- a/plan9/config_sh.sample
+++ b/plan9/config_sh.sample
@@ -246,6 +246,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -687,6 +688,7 @@ full_csh='csh'
 full_sed='/bin/sed'
 gccosandvers=''
 gccversion=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/uconfig.h b/uconfig.h
index 68df40f605..c8bda0fe12 100644
--- a/uconfig.h
+++ b/uconfig.h
@@ -1273,6 +1273,11 @@
  */
 /*#define PERL_OTHERLIBDIRS " "		/ **/
 
+/* GENTOO_LIBDIRS:
+ * Like PERL_OTHERLIBDIRS, but doesn't stuff ARCH dirs in when not wanted
+ */
+/*#define GENTOO_LIBDIRS ""		/ **/
+
 /* PRIVLIB:
  *	This symbol contains the name of the private library for this package.
  *	The library is private in the sense that it needn't be in anyone's
@@ -4159,7 +4164,7 @@
  */
 /*#define	HAS_STDIO_STREAM_ARRAY	/ **/
 #ifdef HAS_STDIO_STREAM_ARRAY
-#define STDIO_STREAM_ARRAY	
+#define STDIO_STREAM_ARRAY
 #endif
 
 /* GMTIME_MAX:
@@ -5282,6 +5287,6 @@
 #endif
 
 /* Generated from:
- * 6edd641b187b02d0daa8cb53f5d22f2dcca115a0d3e744f51b0292d2db484ca5 config_h.SH
- * a9ec40c778a205e0256475b5ef025389f7ea06d75d09ac92414f6b99839577e8 uconfig.sh
+ * eea9b7e3779e6f3300062448ce1a661d10ce9c2bbcce53d8c7c5cca180e8f3b8 config_h.SH
+ * 37dca284f20f2a67761e956be7dae73f5b9610052597f3cbd6ba64e75ed7b4b5 uconfig.sh
  * ex: set ro: */
diff --git a/uconfig.sh b/uconfig.sh
index 6711c3e627..d017d72d6f 100644
--- a/uconfig.sh
+++ b/uconfig.sh
@@ -185,6 +185,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='undef'
 d_getenv_preserves_other_thread='define'
@@ -609,6 +610,7 @@ fpostype=int
 freetype=void
 full_csh=''
 full_sed=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/uconfig64.sh b/uconfig64.sh
index eb122dc867..6c36dcf9c8 100644
--- a/uconfig64.sh
+++ b/uconfig64.sh
@@ -185,6 +185,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='undef'
 d_getenv_preserves_other_thread='define'
@@ -609,6 +610,7 @@ fpostype=int
 freetype=void
 full_csh=''
 full_sed=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/win32/config.gc b/win32/config.gc
index af6fed92fb..e5b914f5b3 100644
--- a/win32/config.gc
+++ b/win32/config.gc
@@ -233,6 +233,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -680,6 +681,7 @@ full_sed=''
 gccansipedantic=''
 gccosandvers=''
 gccversion=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
diff --git a/win32/config.vc b/win32/config.vc
index f4625bf2a4..e3954c5a88 100644
--- a/win32/config.vc
+++ b/win32/config.vc
@@ -233,6 +233,7 @@ d_futimes='undef'
 d_gai_strerror='undef'
 d_gdbm_ndbm_h_uses_prototypes='undef'
 d_gdbmndbm_h_uses_prototypes='undef'
+d_gentoolibdirs='undef'
 d_getaddrinfo='undef'
 d_getcwd='define'
 d_getenv_preserves_other_thread='define'
@@ -679,6 +680,7 @@ full_sed=''
 gccansipedantic=''
 gccosandvers=''
 gccversion=''
+gentoolibdirs=''
 getgrent_r_proto='0'
 getgrgid_r_proto='0'
 getgrnam_r_proto='0'
-- 
2.26.3

